<!DOCTYPE html>
<html>
<head>
    <title>Driver's License Scanner</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
        video { width: 100%; max-width: 500px; border: 2px solid #ccc; }
        .flipped { transform: scaleX(-1); }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; }
        button:disabled { opacity: 0.5; }
        #result { margin-top: 20px; padding: 10px; background: #f0f0f0; }
        .scanning { border: 3px solid #ff6b35; animation: pulse 1s infinite; }
        .success { border: 3px solid #4caf50; }
        .error { border: 3px solid #f44336; }
        .alignment-box { 
            position: absolute; 
            border: 3px solid #00ff00; 
            background: rgba(0, 255, 0, 0.1);
            z-index: 10;
            display: none;
        }
        #videoContainer { position: relative; display: inline-block; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .data-section { background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 5px; border: 1px solid #ddd; }
        .copy-btn { background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-left: 10px; }
        .copy-btn:hover { background: #0056b3; }
        .raw-data { background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; white-space: pre-wrap; word-break: break-all; max-height: 200px; overflow-y: auto; }
        .collapsible { cursor: pointer; padding: 10px; background: #e9ecef; border: none; width: 100%; text-align:Make s left; border-radius: 3px; }
        .collapsible:hover { background: #dee2e6; }
        .content { display: none; padding: 10px 0; }
        .prettified-data { font-family: Arial, sans-serif; line-height: 1.6; }
        .prettified-data div { margin: 5px 0; padding: 5px; background: white; border-radius: 3px; }
        .download-btn { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer; margin: 10px 5px; }
        .download-btn:hover { background: #218838; }
        .annotated-image { max-width: 100%; height: auto; border: 2px solid #28a745; border-radius: 5px; margin: 10px 0; }
        #stats { position: fixed; top: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 5px; font-size: 12px; max-width: 200px; }
        label { margin: 0 10px; font-size: 14px; }
    </style>
</head>
<body>
    <h1>Driver's License Scanner</h1>
    <p><strong>Tip:</strong> Use iPhone or high-quality cameras for best results. PDF417 barcodes contain dense information requiring good camera resolution.</p>
    <p>Note: Lighting must be very even, and the barcode in the back must be inside the green box overlay to work.</p>
    <div id="videoContainer">
        <video id="video" autoplay></video>
        <div id="alignmentBox" class="alignment-box"></div>
    </div>
    <br>
    <select id="cameraSelect" onchange="switchCamera()">
        <option value="">Select Camera</option>
    </select>
    <button onclick="startCamera()">Start Camera</button>
    <button onclick="flipCamera()">Flip Camera</button>
    <br><br>
    <label>Box Width (%): <input type="number" id="boxWidth" value="70" min="10" max="100" onchange="updateOverlay()"></label>
    <label>Box Height (%): <input type="number" id="boxHeight" value="15" min="5" max="50" onchange="updateOverlay()"></label>
    <div id="result"></div>
    <div id="stats">Loading scan statistics...</div>
    <footer><a href="https://example.com">Visit My Homepage</a></footer>

    <script>
        let video = document.getElementById('video');
        let scanning = false;
        let currentStream = null;
        let autoScanInterval = null;
        let cameras = [];
        let idleTimer = null;
        let boxWidth = 70;
        let boxHeight = 15;

        // Parse URL parameters
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('width')) {
                boxWidth = Math.max(10, Math.min(100, parseInt(params.get('width'))));
                document.getElementById('boxWidth').value = boxWidth;
            }
            if (params.has('height')) {
                boxHeight = Math.max(5, Math.min(50, parseInt(params.get('height'))));
                document.getElementById('boxHeight').value = boxHeight;
            }
        }

        // Idle detection
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                window.location.href = 'https://example.com';
            }, 300000); // 5 minutes
        }

        // Track user activity
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
            document.addEventListener(event, resetIdleTimer, true);
        });

        resetIdleTimer();

        // Get available cameras on page load
        window.onload = async () => {
            parseUrlParams();
            await getCameras();
            loadStats();
        };

        function loadStats() {
            fetch('/scan-stats')
                .then(response => response.json())
                .then(stats => {
                    let html = `<strong>Total scans: ${stats.total_scans}</strong>`;
                    if (stats.last_scans.length > 0) {
                        html += '<br>Last: ' + new Date(stats.last_scans[stats.last_scans.length - 1]).toLocaleString();
                    }
                    const statsDiv = document.getElementById('stats');
                    if (statsDiv) statsDiv.innerHTML = html;
                })
                .catch(() => {
                    const statsDiv = document.getElementById('stats');
                    if (statsDiv) statsDiv.innerHTML = 'Stats unavailable';
                });
        }

        async function getCameras() {
            try {
                // Request camera permission first to get labels
                await navigator.mediaDevices.getUserMedia({ video: true });
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                cameras = devices.filter(device => device.kind === 'videoinput');
                const select = document.getElementById('cameraSelect');
                select.innerHTML = '<option value="">Select Camera</option>';
                
                cameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.text = camera.label || `Camera ${index + 1}`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error getting cameras:', err);
            }
        }

        async function startCamera() {
            const selectedCamera = document.getElementById('cameraSelect').value;
            if (!selectedCamera) {
                alert('Please select a camera first');
                return;
            }
            
            const constraints = {
                video: {
                    deviceId: { exact: selectedCamera },
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            };
            
            try {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = currentStream;
                
                // Set up alignment box when video loads
                video.onloadedmetadata = () => {
                    setupAlignmentBox();
                    document.getElementById('alignmentBox').style.display = 'block';
                    // Start automatic scanning
                    autoScanInterval = setInterval(captureFrame, 1000);
                };
            } catch (err) {
                document.getElementById('result').innerHTML = 'Error accessing camera: ' + err.message;
            }
        }

        function setupAlignmentBox() {
            const video = document.getElementById('video');
            const alignmentBox = document.getElementById('alignmentBox');
            
            const boxWidthPx = video.offsetWidth * (boxWidth / 100);
            const boxHeightPx = video.offsetHeight * (boxHeight / 100);
            const boxLeft = (video.offsetWidth - boxWidthPx) / 2;
            const boxTop = (video.offsetHeight - boxHeightPx) / 2;
            
            alignmentBox.style.width = boxWidthPx + 'px';
            alignmentBox.style.height = boxHeightPx + 'px';
            alignmentBox.style.left = boxLeft + 'px';
            alignmentBox.style.top = boxTop + 'px';
        }

        function updateOverlay() {
            boxWidth = parseInt(document.getElementById('boxWidth').value);
            boxHeight = parseInt(document.getElementById('boxHeight').value);
            if (document.getElementById('alignmentBox').style.display === 'block') {
                setupAlignmentBox();
            }
        }

        function flipCamera() {
            const video = document.getElementById('video');
            video.classList.toggle('flipped');
        }

        async function switchCamera() {
            if (currentStream) {
                document.getElementById('alignmentBox').style.display = 'none';
                startCamera();
            }
        }

        // Resize alignment box when window resizes
        window.addEventListener('resize', setupAlignmentBox);
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function toggleRawData() {
            const content = document.getElementById('rawDataContent');
            content.style.display = content.style.display === 'block' ? 'none' : 'block';
        }
        
        function copyPrettifiedData() {
            const prettifiedData = document.getElementById('prettifiedData');
            const text = Array.from(prettifiedData.children).map(div => div.textContent).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('Prettified data copied to clipboard!');
            });
        }
        
        function copyRawData() {
            const rawData = document.getElementById('rawData').textContent;
            navigator.clipboard.writeText(rawData).then(() => {
                alert('Raw data copied to clipboard!');
            });
        }
        
        function downloadBase64Image(base64Data) {
            const link = document.createElement('a');
            link.href = 'data:image/jpeg;base64,' + base64Data;
            link.download = 'annotated_scan.jpg';
            link.click();
        }

        async function captureFrame() {
            if (scanning) return;
            scanning = true;
            
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('image', blob, 'frame.jpg');
                formData.append('box_width', boxWidth);
                formData.append('box_height', boxHeight);
                
                try {
                    const response = await fetch('/scan', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        // Success feedback - stop auto scanning and turn red
                        clearInterval(autoScanInterval);
                        video.className = 'error'; // Red border for success
                        if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
                        
                        // Update stats
                        loadStats();
                        
                        let html = '<h3>License Decoded Successfully!</h3>';
                        
                        // Display annotated image
                        if (result.image_base64) {
                            html += '<img src="data:image/jpeg;base64,' + result.image_base64 + '" class="annotated-image" alt="Annotated scan">';
                            html += '<br><button class="download-btn" onclick="downloadBase64Image(\'' + result.image_base64 + '\')">Download Image</button>';
                        }
                        
                        // Prettified data section
                        html += '<div class="data-section">';
                        html += '<h4>License Information <button class="copy-btn" onclick="copyPrettifiedData()">Copy All</button></h4>';
                        html += '<div id="prettifiedData" class="prettified-data">';
                        
                        for (const [key, value] of Object.entries(result.data)) {
                            html += '<div><strong>' + key + ':</strong> ' + value + '</div>';
                        }
                        
                        html += '</div></div>';
                        
                        // Raw data section (collapsible)
                        if (result.raw_data) {
                            html += '<div class="data-section">';
                            html += '<button class="collapsible" onclick="toggleRawData()">Show Raw Data <button class="copy-btn" onclick="copyRawData(); event.stopPropagation();">Copy Raw</button></button>';
                            html += '<div id="rawDataContent" class="content">';
                            html += '<div id="rawData" class="raw-data">' + escapeHtml(result.raw_data) + '</div>';
                            html += '</div></div>';
                        }
                        
                        document.getElementById('result').innerHTML = html;
                    }
                } catch (err) {
                    // Silent fail for continuous scanning
                }
                
                scanning = false;
            }, 'image/jpeg');
        }
    </script>
</body>
</html>
